<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="style.css">
    <script src="middle-name.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>
    <title>Remy's Party App | Guess Lena's Belly Size</title>
</head>
<body>
<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container-fluid">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/baby-shower-app/index.html">Home</a>
        </div>

        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav">
                <li><a href="/baby-shower-app/middle-name.html">Suggest A Middle Name</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li id="openGuestNameModal" style="display: none;"><a href="#" data-toggle="modal" data-target="#addGuestModal"><strong>Click here to enter your name</strong></a></li>
                <li id="guestGreeting" style="display: none;"><a href="#" data-toggle="modal" data-target="#editGuestModal" id="guestGreetingText">Hello </a></li>
            </ul>
        </div>
    </div>
</nav>


<div class="container">
  <!-- New Guest Modal -->
  <div class="modal fade" id="addGuestModal" tabindex="-1" role="dialog" aria-labelledby="addGuestModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addGuestModalLabel">Please Enter Your Name To Participate</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="input-group">
            <span class="input-group-addon" id="sizing-addon2">Your Name</span>
            <input type="text" class="form-control" placeholder="" aria-describedby="sizing-addon2" id="guestNameInput" style="">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="setGuestName">Save</button>
        </div>
      </div>
    </div>
  </div>

    <!-- Modify Guest Modal -->
    <div class="modal fade" id="editGuestModal" tabindex="-1" role="dialog" aria-labelledby="editGuestModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="editGuestModalLabel">Edit Your Display Name</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <div class="input-group">
                <span class="input-group-addon" id="sizing-addon2">Your Name</span>
                <input type="text" class="form-control" placeholder="" aria-describedby="sizing-addon2" id="editGuestNameInput" style="">
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              <button type="button" class="btn btn-primary" id="editGuestNameButton">Save changes</button>
            </div>
          </div>
        </div>
      </div>

    <h1 style="text-align: center; margin-top: 250px; font-size: 4em;">Guess Lena's Belly size!</h1>
    <div class="alert alert-warning alert-dismissible fade in" role="alert" style="margin-top: 50px; display: none;">
        <strong id="dynamicNote">Test Dynamic Note</strong>
    </div>

    <p style="margin-top: 50px; font-size: 2em;" id="bellyNote">Please click on the top right to enter your name in order to participate. </p>

    <div id="questionArea">
        <div style="display: flex; flex-direction: column; margin-top: 100px;" id="">
            <!--div style="display: flex; align-items: center; border: 1px solid blue; height: 150px; width: 10px; font-size: 3em; padding-left: 25px; margin-top: 25px;">Oliver</div>
            <div style="display: flex; align-items: center; border: 1px solid blue; height: 150px; width: 60px; font-size: 3em; padding-left: 25px; margin-top: 25px;">Ollie</div>
            <div style="display: flex; align-items: center; border: 1px solid blue; height: 150px; width: 110px; font-size: 3em; padding-left: 25px; margin-top: 25px;">Tom</div-->
        </div>
    </div>
    <div id="guessBellySection">
        <div class="input-group input-group-lg" style="margin-top: 150px; width: 100%;">
            <label id="guessBellyLabel" class="" for="guessBellyInput" style="display: none; font-size: 2em;">Belly Size In Centimeters</label>
            <input id="guessBellyInput" type="number" step="1" class="form-control" placeholder="" onkeypress="return event.charCode >= 48 && event.charCode <= 57" style="width: 100%; display: none;">
        </div>
        <div class="input-group" style="margin-top: 10px; width: 100%; text-align: center;">
            <button id="guessBellyButton" class="btn btn-primary btn-block btn-lg" style="width: 100%; display: none">Submit</button>
        </div>
        <div class="input-group input-group-lg" style="width: 100%; display: none;" id="alreadyGuessedInputDiv">
            <input id="alreadyGuessedInput" type="text" class="form-control" maxlength="1" placeholder="You have already guessed. " disabled>
        </div>
        <br>
        <div style="margin-top: 50px;"></div>
    </div>
</div>
    <script src="middle-name.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js';
        import { getFirestore, collection, getDocs, doc, setDoc, updateDoc, addDoc } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';
        const firebaseConfig = {
            apiKey: "AIzaSyAoDqyAV3JHc5Je3LvlZ3JBNCXSysnqhAs",
            authDomain: "baby-shower-app-865b6.firebaseapp.com",
            databaseURL: "https://baby-shower-app-865b6-default-rtdb.firebaseio.com",
            projectId: "baby-shower-app-865b6",
            storageBucket: "baby-shower-app-865b6.appspot.com",
            messagingSenderId: "345574283729",
            appId: "1:345574283729:web:3f095573e6db205c9068f0",
            measurementId: "G-5JFZBLLEQC"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        var db = getFirestore(app);

        async function getBellyGuesses(db, guess) {
            const bellyGuessesCollection = collection(db, 'belly');
            const bellyGuessesSnapshot = await getDocs(bellyGuessesCollection);
            const bellyGuessesList = bellyGuessesSnapshot.docs.map(doc => doc.data());
            console.log("getBellyGuesses");
            console.log(JSON.stringify(bellyGuessesList[0][guess]));
            
            return bellyGuessesList[0][guess];
        }

        async function addBellyGuess(db, guess, guestDisplayName) {
            const bellyGuessRef = doc(db, "belly", "guesses");

            console.log(guess + " | " + guestDisplayName);

            await updateDoc(bellyGuessRef, {
                [guess]: [guestDisplayName]
            });
        }

        async function appendGuestIdToMiddleName(db, guess, guestDisplayName) {
            let bellyGuesses = await getBellyGuesses(db, guess);
            console.log("appendGuestIdToMiddleName");
            console.log(JSON.stringify(bellyGuesses));

            if (bellyGuesses === undefined || bellyGuesses.length == 0) {
                addBellyGuess(db, guess, guestDisplayName);
            } else if (bellyGuesses.includes(guestDisplayName)) {
                console.log("Already voted for this name. ");
            } else {
                bellyGuesses.push(guestDisplayName);
                const bellyGuessesRef = doc(db, "belly", "guesses");
                //await updateDoc(bellyGuessesRef, bellyGuesses);
                await updateDoc(bellyGuessesRef, {
                    [guess]: bellyGuesses
                });
            }


            localStorage.setItem("remyBellyGuessed", true);
            location.reload();
        }

        async function guessBelly() {
            if (!localStorage.getItem("remyGuestId")) {
                console.log("No name set");
                return;
            }

            let guess = document.getElementById("guessBellyInput").value + "cm";
            let guestDisplayName = localStorage.getItem("remyGuestDisplayName");

            if (localStorage.getItem("remyBellyGuessed")) {
                    return;
            }

            if (confirm("Are you sure you want to guess " + guess + "?")) {
                await appendGuestIdToMiddleName(db, guess, guestDisplayName);
                localStorage.setItem("remyBellyGuessed", true);
                localStorage.setItem("remyBellyGuess", guess);
                window.location.reload();
            }
        }

        async function getGuests(db) {
            const guestsCollection = collection(db, 'guests');
            const guestsSnapshot = await getDocs(guestsCollection);
            const guestsList = guestsSnapshot.docs.map(doc => doc.data());
            console.log(JSON.stringify(guestsList[0]));
            return guestsList[0];
        }

        async function addGuest(db, guestId, guestDisplayName) {
            let data = {
                displayName: guestDisplayName,
            }

            let results = await setDoc(doc(db, "guests", guestId), data);
            localStorage.setItem("remyGuestId", guestId);
            localStorage.setItem("remyGuestDisplayName", guestDisplayName);
            location.reload();
        }

        async function updateGuestDisplayName(db, guestId, guestDisplayName) {
            const guestsRef = doc(db, "guests", guestId);
            
            await updateDoc(guestsRef, {
                displayName: guestDisplayName
            });
            localStorage.setItem("remyGuestDisplayName", guestDisplayName);
            window.location.reload();
        }

        async function setGuestName() {
            let guestDisplayName = document.getElementById("guestNameInput").value;
            if (guestDisplayName === "") {
                console.log("No name entered. ");
                return;
            }

            //Get current user's user agent
            let guestUserAgent = navigator.userAgent;
            guestUserAgent = guestUserAgent.replace(/[^a-zA-Z0-9]/g, '');
            let guestId = guestDisplayName + "-=-" + guestUserAgent;

            addGuest(db, guestId, guestDisplayName)
        }

        async function editGuestName() {
            let guestDisplayName = document.getElementById("editGuestNameInput").value;
            if (guestDisplayName === "") {
                console.log("No name entered. ");
                return;
            }

            let guestId = localStorage.getItem("remyGuestId");
            updateGuestDisplayName(db, guestId, guestDisplayName)
        }
        
        $(document).ready(function() {
            if (localStorage.getItem("remyGuestId") && localStorage.getItem("remyGuestDisplayName")) {
                //<li id="openGuestNameModal"><a href="#" data-toggle="modal" data-target="#addGuestModal" style="display: none;">Please set your name to participate</a></li>
                //<li id="guestGreeting" style="display: none;"><a href="#" data-toggle="modal" data-target="#addGuestModal">Hello </a></li>
                document.getElementById("openGuestNameModal").style.display = "none";
                document.getElementById("guestGreetingText").textContent = "Hello " + localStorage.getItem("remyGuestDisplayName");
                document.getElementById("guestGreeting").style.display = "block";
                document.getElementById("editGuestNameInput").value = localStorage.getItem("remyGuestDisplayName");
                document.getElementById("bellyNote").textContent = "Guess Lena's belly size (rounded to the nearest number) in centimeters! (You can only guess once) ";
                showSubmitButton();
            } else {
                document.getElementById("openGuestNameModal").style.display = "block";
                document.getElementById("guestGreeting").style.display = "none";
            }

            //Event Listers
            //Add event listener for element with id "setGuestName" to run function setGuestName when clicked
            document.getElementById("setGuestName").addEventListener("click", setGuestName);
            document.getElementById("editGuestNameButton").addEventListener("click", editGuestName);
            document.getElementById("guessBellyButton").addEventListener("click", guessBelly);
            let namesElements = document.getElementsByClassName("voteMiddleName");
            for (let i = 0; i < namesElements.length; i++) {
                namesElements[i].addEventListener("click", voteForName);
            }
        });

        function showSubmitButton() {
            if (localStorage.getItem("remyBellyGuessed")) {
                document.getElementById("guessBellyInput").style.display = "none";
                document.getElementById("guessBellyLabel").style.display = "none";
                document.getElementById("guessBellyButton").style.display = "none";
                document.getElementById("alreadyGuessedInputDiv").style.display = "block";
                document.getElementById("alreadyGuessedInput").placeholder = "You have already guessed " + localStorage.getItem("remyBellyGuess") + ". "
            } else {
                document.getElementById("guessBellyInput").style.display = "block";
                document.getElementById("guessBellyLabel").style.display = "block";
                document.getElementById("guessBellyButton").style.display = "block";
            }
        }

    </script>
</body>
</html>
