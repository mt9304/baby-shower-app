<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="style.css">
    <script src="middle-name.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>
    <title>Remy's Party App | Suggest A Middle Name</title>
</head>
<body>
<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container-fluid">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/baby-shower-app/index.html">Home</a>
        </div>

        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav">
                <li><a href="/baby-shower-app/middle-name.html">Suggest Middle Name</a></li>
            </ul>
            <ul class="nav navbar-nav">
                <li><a href="/baby-shower-app/belly.html">Guess Belly Size</a></li>
            </ul>
            <!--ul class="nav navbar-nav">
                <li><a href="/baby-shower-app/parenting.html">Suggest Parenting Tips</a></li>
            </ul-->
            <ul class="nav navbar-nav">
                <li><a href="/baby-shower-app/message.html">Leave A Message</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li id="openGuestNameModal" style="display: none;"><a href="#" data-toggle="modal" data-target="#addGuestModal"><strong>Click here to enter your name</strong></a></li>
                <li id="guestGreeting" style="display: none;"><a href="#" data-toggle="modal" data-target="#editGuestModal" id="guestGreetingText">Hello </a></li>
            </ul>
        </div>
    </div>
</nav>


<div class="container">
  <!-- New Guest Modal -->
  <div class="modal fade" id="addGuestModal" tabindex="-1" role="dialog" aria-labelledby="addGuestModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addGuestModalLabel">Please Enter Your Name To Participate</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="input-group">
            <span class="input-group-addon" id="sizing-addon2">Your Name</span>
            <input type="text" class="form-control" placeholder="" aria-describedby="sizing-addon2" id="guestNameInput" style="">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="setGuestName">Save</button>
        </div>
      </div>
    </div>
  </div>

    <!-- Modify Guest Modal -->
    <div class="modal fade" id="editGuestModal" tabindex="-1" role="dialog" aria-labelledby="editGuestModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="editGuestModalLabel">Edit Your Display Name</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <div class="input-group">
                <span class="input-group-addon" id="sizing-addon2">Your Name</span>
                <input type="text" class="form-control" placeholder="" aria-describedby="sizing-addon2" id="editGuestNameInput" style="">
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              <button type="button" class="btn btn-primary" id="editGuestNameButton">Save changes</button>
            </div>
          </div>
        </div>
      </div>

    <h1 style="text-align: center; margin-top: 250px; font-size: 4em;">Vote or suggest a middle name for Remy!</h1>
    <div class="alert alert-warning alert-dismissible fade in" role="alert" style="margin-top: 50px; display: none;">
        <strong>Test Dynamic Note</strong>
    </div>

    <p style="margin-top: 50px; font-size: 2em;" id="middleNameNote">Please click on the top right to enter your name in order to participate. </p>

    <div id="questionArea">
        <div style="display: flex; flex-direction: column; margin-top: 100px;" id="middleNamesList">
            <!--div style="display: flex; align-items: center; border: 1px solid blue; height: 150px; width: 10px; font-size: 3em; padding-left: 25px; margin-top: 25px;">Oliver</div>
            <div style="display: flex; align-items: center; border: 1px solid blue; height: 150px; width: 60px; font-size: 3em; padding-left: 25px; margin-top: 25px;">Ollie</div>
            <div style="display: flex; align-items: center; border: 1px solid blue; height: 150px; width: 110px; font-size: 3em; padding-left: 25px; margin-top: 25px;">Tom</div-->
        </div>
    </div>
    <div id="suggestNameSection">
        <div class="input-group input-group-lg" style="margin-top: 150px; width: 100%;">
            <label id="suggestNameLabel" class="" for="suggestNameInput" style="display: none; font-size: 2em;">Suggest a middle name!</label>
            <input id="suggestNameInput" type="text" class="form-control" maxlength="10" placeholder="1 suggestion per person" style="width: 100%; display: none;">
        </div>
        <div class="input-group" style="margin-top: 10px; width: 100%; text-align: center;">
            <button id="suggestNameButton" class="btn btn-primary btn-block btn-lg" style="width: 100%; display: none">Submit</button>
        </div>
        <div class="input-group input-group-lg" style="width: 100%; display: none;" id="alreadySuggestedNameInput">
            <input type="text" class="form-control" maxlength="1" placeholder="You have already suggested a name. " disabled>
        </div>
        <br>
        <div style="margin-top: 50px;"></div>
    </div>
</div>
    <script src="middle-name.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js';
        import { getFirestore, collection, getDocs, doc, setDoc, updateDoc, addDoc } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';
        const firebaseConfig = {
            apiKey: "AIzaSyAoDqyAV3JHc5Je3LvlZ3JBNCXSysnqhAs",
            authDomain: "baby-shower-app-865b6.firebaseapp.com",
            databaseURL: "https://baby-shower-app-865b6-default-rtdb.firebaseio.com",
            projectId: "baby-shower-app-865b6",
            storageBucket: "baby-shower-app-865b6.appspot.com",
            messagingSenderId: "345574283729",
            appId: "1:345574283729:web:3f095573e6db205c9068f0",
            measurementId: "G-5JFZBLLEQC"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        var db = getFirestore(app);

        async function getMiddleNames(db) {
            const middleNamesCollection = collection(db, 'middleNames');
            const middleNamesSnapshot = await getDocs(middleNamesCollection);
            const middleNamesList = middleNamesSnapshot.docs.map(doc => doc.data());
            //console.log(JSON.stringify(middleNamesList[0]));
            return middleNamesList[0];
        }
        
        async function addMiddleName(db, name, guestId) {
            const middleNameRef = doc(db, "middleNames", "names");

            try {
                let previousVote = localStorage.getItem("remyNameVoted");
                if (previousVote) {
                    await removeGuestIdFromMiddleName(db, previousVote, guestId);
                }
            } catch (e) {
                
            }
            
            await updateDoc(middleNameRef, {
                [name]: [guestId]
            });
        }
        
        async function suggestName() {
            let suggestedName = document.getElementById("suggestNameInput").value;
            let guestId = localStorage.getItem("remyGuestId");
            
            if (suggestedName === "") {
                console.log("No name entered.  ");
                return;
            }

            //if suggestedName is already in the middleNames key regardless of case, then don't add it
            let middleNames = await getMiddleNames(db);
            //console.log(JSON.stringify(middleNames));
            
            let lowerCaseSuggestedName = suggestedName.toLowerCase();
            let keys = Object.keys(middleNames).map(k => k.toLowerCase());
            console.log(JSON.stringify(keys));
            
            if (keys.includes(lowerCaseSuggestedName)) {
                console.log("Name already exists. ")
                return;
            }

            await addMiddleName(db, suggestedName, guestId)
            localStorage.setItem("remySuggestedName", true);
            localStorage.setItem("remyNameSuggested", suggestedName);
            localStorage.setItem("remyNameVoted", suggestedName);
            window.location.reload();
        }

        async function appendGuestIdToMiddleName(db, name, guestId) {
            let middleNames = await getMiddleNames(db);
            let guestIds = middleNames[name];

            if (guestIds.includes(guestId)) {
                console.log("Already voted for this name. ");
                return;
            }

            guestIds.push(guestId);

            const middleNameRef = doc(db, "middleNames", "names");
            await updateDoc(middleNameRef, {
                [name]: guestIds
            });
            //localStorage.setItem("remyNameVoted", name);
        }

        async function removeGuestIdFromMiddleName(db, name, guestId) {
            let middleNames = await getMiddleNames(db);
            let guestIds = middleNames[name];

            if (guestIds) {
                try {
                    if (guestIds.includes(guestId)) {
                        let index = guestIds.indexOf(guestId);
                        if (index > -1) {
                            guestIds.splice(index, 1);
                        }
                    }
                } catch {
                    console.log("Could not remove id. ");
                }

                const middleNameRef = doc(db, "middleNames", "names");
                await updateDoc(middleNameRef, {
                    [name]: guestIds
                });
            }


        }

        async function voteForName(e) {
            if (!localStorage.getItem("remyGuestId")) {
                console.log("No name set");
                return;
            }

            let nameClicked = e.target.dataset.name;
            let votes = e.target.dataset.votes;         
            let guestId = localStorage.getItem("remyGuestId");

            if (localStorage.getItem("remyNameSuggested" == nameClicked) || localStorage.getItem("remyNameVoted" == nameClicked)) {
                    return;
            }

            if (confirm("Are you sure you want to vote for " + nameClicked + "?")) {
                let previouslyVotedName = localStorage.getItem("remyNameVoted");
                await removeGuestIdFromMiddleName(db, previouslyVotedName, guestId);
                await appendGuestIdToMiddleName(db, nameClicked, guestId);
                localStorage.setItem("remyNameVoted", nameClicked);
                window.location.reload();
            }
        }

        async function getGuests(db) {
            const guestsCollection = collection(db, 'guests');
            const guestsSnapshot = await getDocs(guestsCollection);
            const guestsList = guestsSnapshot.docs.map(doc => doc.data());
            console.log(JSON.stringify(guestsList[0]));
            return guestsList[0];
        }

        async function addGuest(db, guestId, guestDisplayName) {
            let data = {
                displayName: guestDisplayName,
            }

            let results = await setDoc(doc(db, "guests", guestId), data);
            localStorage.setItem("remyGuestId", guestId);
            localStorage.setItem("remyGuestDisplayName", guestDisplayName);
            location.reload();
        }

        async function updateGuestDisplayName(db, guestId, guestDisplayName) {
            const guestsRef = doc(db, "guests", guestId);
            
            await updateDoc(guestsRef, {
                displayName: guestDisplayName
            });
            localStorage.setItem("remyGuestDisplayName", guestDisplayName);
            window.location.reload();
        }

        async function setGuestName() {
            let guestDisplayName = document.getElementById("guestNameInput").value;
            if (guestDisplayName === "") {
                console.log("No name entered. ");
                return;
            }

            //Get current user's user agent
            let guestUserAgent = navigator.userAgent;
            guestUserAgent = guestUserAgent.replace(/[^a-zA-Z0-9]/g, '');
            let guestId = guestDisplayName + "-=-" + guestUserAgent;

            addGuest(db, guestId, guestDisplayName)
        }

        async function editGuestName() {
            let guestDisplayName = document.getElementById("editGuestNameInput").value;
            if (guestDisplayName === "") {
                console.log("No name entered. ");
                return;
            }

            let guestId = localStorage.getItem("remyGuestId");
            updateGuestDisplayName(db, guestId, guestDisplayName)
        }

        //updateMiddleName(db, "Oscar", "guest1");
        let middleNames = await getMiddleNames(db);
        //console.log(JSON.stringify(middleNames));
        PopulateListOfMiddleNames(middleNames);


        

        
        $(document).ready(function() {
            if (localStorage.getItem("remyGuestId") && localStorage.getItem("remyGuestDisplayName")) {
                //<li id="openGuestNameModal"><a href="#" data-toggle="modal" data-target="#addGuestModal" style="display: none;">Please set your name to participate</a></li>
                //<li id="guestGreeting" style="display: none;"><a href="#" data-toggle="modal" data-target="#addGuestModal">Hello </a></li>
                document.getElementById("openGuestNameModal").style.display = "none";
                document.getElementById("guestGreetingText").textContent = "Hello " + localStorage.getItem("remyGuestDisplayName");
                document.getElementById("guestGreeting").style.display = "block";
                document.getElementById("editGuestNameInput").value = localStorage.getItem("remyGuestDisplayName");
                document.getElementById("middleNameNote").textContent = "Tap on a name to cast your vote or suggest a new one at the bottom (1 vote or suggestion per person). You can switch your votes. ";
                showSubmitButton();
            } else {
                document.getElementById("openGuestNameModal").style.display = "block";
                document.getElementById("guestGreeting").style.display = "none";
            }

            //Event Listers
            //Add event listener for element with id "setGuestName" to run function setGuestName when clicked
            document.getElementById("setGuestName").addEventListener("click", setGuestName);
            document.getElementById("editGuestNameButton").addEventListener("click", editGuestName);
            document.getElementById("suggestNameButton").addEventListener("click", suggestName);
            let namesElements = document.getElementsByClassName("voteMiddleName");
            for (let i = 0; i < namesElements.length; i++) {
                namesElements[i].addEventListener("click", voteForName);
            }
        });

        function showSubmitButton() {
            if (localStorage.getItem("remySuggestedName")) {
                document.getElementById("suggestNameInput").style.display = "none";
                document.getElementById("suggestNameLabel").style.display = "none";
                document.getElementById("suggestNameButton").style.display = "none";
                document.getElementById("alreadySuggestedNameInput").style.display = "block";
            } else {
                document.getElementById("suggestNameInput").style.display = "block";
                document.getElementById("suggestNameLabel").style.display = "block";
                document.getElementById("suggestNameButton").style.display = "block";
            }
        }

    </script>
</body>
</html>
